---
output:
  word_document:
    reference_docx: ../MPFF report template v1.1.dotx
---


```{r setup, include=FALSE}
# ==========================================================================================================
# NZO JFF v1.1
# 
# 07/05/2025 first coding
# ==========================================================================================================

knitr::opts_chunk$set(echo = FALSE,	message = FALSE,	warning = FALSE,	comment = "",	crop = TRUE )
knitr::opts_chunk$set(fig.width=10) 

options(dplyr.summarise.inform = FALSE)

sf::sf_use_s2(FALSE)

# Reset lists
rm(list=ls())

# Libraries
library(rmarkdown)                   # note: requires knitr 1.21

require(tidyverse, quietly=TRUE)     # combined package of dplyr, tidyr, ggplot, readr, purrr and tibble
require(lubridate, quietly=TRUE)     # data handling
require(reshape2, quietly=TRUE)      # reshaping data; e.g. cast
require(RColorBrewer)                # colour schemes
library(viridis)
library(pander)
library(readxl)
library(patchwork)

# Source all the utils
source("../../flyshoot/R/FLYSHOOT utils.r")

onedrive   <- "C:/DATA"
load(file=paste(onedrive, "RDATA/world_mr_sf.RData", sep="/"))
# load(file=paste(onedrive, "RDATA/eez_sf.RData", sep="/"))
# load(file=paste(onedrive, "RDATA/eez_sf.RData", sep="/"))

datadir  <- "C:/Users/MartinPastoors/Martin Pastoors/NZO - General/WKC/adviezen/2025-xx Fact Finding beschermde gebieden/data"
rdatadir  <- "C:/Users/MartinPastoors/Martin Pastoors/NZO - General/WKC/adviezen/2025-xx Fact Finding beschermde gebieden/rdata"
shapedir  <- "C:/Users/MartinPastoors/Martin Pastoors/NZO - General/WKC/adviezen/2025-xx Fact Finding beschermde gebieden/shapes"
bisidir  <- "C:/Users/MartinPastoors/Martin Pastoors/NZO - General/WKC/adviezen/2025-xx Fact Finding beschermde gebieden/data/BISI"
wserdir  <- "C:/Users/MartinPastoors/Martin Pastoors/NZO - General/WKC/adviezen/2025-xx Fact Finding beschermde gebieden/data/WSER"
scenariodir  <- "C:/Users/MartinPastoors/Martin Pastoors/NZO - General/WKC/adviezen/2025-xx Fact Finding beschermde gebieden/scenarios"

# load combined areas 
jff_comb <- 
  loadRData(file=file.path(rdatadir, "jff_comb_v1.1.RData")) %>% 
  sf::st_make_valid()
# sf::st_is_valid(jff_comb)

# jff_comb %>% 
#   filter(grepl("viss",SITE_NAME)) %>% 
#   ggplot() +
#   theme_publication() +
#   geom_sf(aes(fill=SITE_NAME)) +
#   geom_sf_text(aes(label=area_km2)) +
#   geom_sf(data=world_mr_sf, fill="lightgray") +
#   geom_sf(data=eez_sf, fill=NA, linetype="dashed") +
#   coord_sf(xlim=c(5,6), ylim=c(53,54)) +
#   facet_wrap(~SITE_NAME)

# load NL EEZ
load(file=file.path(rdatadir, "nl_eez_all.RData"))

# library(graticule)
# grid <- graticule(
#   lon = seq(bb[1], bb[3], 0.0625),
#   lat = seq(bb[2], bb[4], 0.03125)
#   ) %>% 
#   sf::st_as_sf() %>% 
#   sf::st_transform(crs=4326) 

# load Partiele Herziening gebieden
load(file=file.path(rdatadir, "ph_natuur.RData"))
load(file=file.path(rdatadir, "ph_windenergie.RData"))
load(file=file.path(rdatadir, "ph_zandwinning.RData"))
load(file=file.path(rdatadir, "ph_scheepvaart.RData"))
load(file=file.path(rdatadir, "nlog.RData"))

# read the WSER gebieden
wsergebieden <- 
  readxl::read_excel(file.path(wserdir, "WSER gebieden gecombineerd.xlsx"), col_names = TRUE) 

# load WSER grid
wsergrid <- readRDS(file.path(wserdir,"grid.Rdata")) %>% 
  left_join(wsergebieden, by=c("gridID")) %>% 
  sf::st_transform(crs=4326) %>% 
  filter(!(gridID %in% c(27253, 27014, 27015) & gebied == "Voordelta"))


# load EUSeaMap NL 
euseamap_nl <- 
  loadRData(file=file.path(rdatadir, "euseamap_nl.RData")) %>% 
    mutate(krm_ecotoop = case_when(
      grepl("Infralittoral coarse sediment|Circalittoral coarse sediment", MSFD_BBHT)   ~ "Ondiep grof sediment",
      grepl("Circalittoral mixed sediment"                               , MSFD_BBHT)   ~ "Ondiep grof sediment",
      grepl("Offshore circalittoral coarse sediment"                     , MSFD_BBHT)   ~ "Diep grof sediment",
      grepl("Offshore circalittoral mixed sediment"                      , MSFD_BBHT)   ~ "Diep grof sediment",
      grepl("Circalittoral sand|Infralittoral sand"                      , MSFD_BBHT)   ~ "Ondiep zand",
      grepl("Offshore circalittoral sand"                                , MSFD_BBHT)   ~ "Diep zand",
      grepl("Infralittoral mud|Circalittoral mud"                        , MSFD_BBHT)   ~ "Ondiep slibrijk",
      grepl("Offshore circalittoral mud"                                 , MSFD_BBHT)   ~ "Diep slibrijk",
      TRUE                                                                              ~ "Overig"
     )) %>% 
  sf::st_make_valid() %>% 
  sf::st_transform(crs=23031) %>%   
  dplyr::mutate(area_km2 = as.numeric(sf::st_area(.)/1000000)) %>% 
  dplyr::mutate(area_ha = as.numeric(sf::st_area(.)/10000)) %>% 
  sf::st_transform(crs=4326) 


# Intersection between EUseamap and JFF_COMB gebieden
jff_bht <-
  sf::st_intersection(jff_comb, euseamap_nl) %>% 
  
  sf::st_transform(crs=23031) %>%   
  dplyr::mutate(area_km2 = as.numeric(sf::st_area(.)/1000000)) %>% 
  dplyr::mutate(area_ha = as.numeric(sf::st_area(.)/10000)) %>% 
  sf::st_transform(crs=4326) %>% 
  dplyr::select(-OBJECTID) %>% 
  tibble::rownames_to_column(var="OBJECTID") %>% 
  mutate(OBJECTID = as.integer(OBJECTID)) %>% 
  dplyr::select(OBJECTID, SITE_NAME, SITE_TYPE, SITE_REG, krm_ecotoop, MSFD_BBHT, EUNIScombD, area_km2, area_ha)


# Intersection between PH_natuur and JFF_COMB gebieden
tmp <- ph_natuur %>% 
  filter(layer %in% c("KRM_20240822","Natuurbescherming")) %>% 
  dplyr::select(Gebied, NAAM_N2K, TYPE, BESCHERMIN, geometry) %>% 
  mutate(gebied = ifelse(!is.na(Gebied), Gebied, NAAM_N2K)) %>% 
  mutate(bescherming = ifelse(!is.na(BESCHERMIN), BESCHERMIN, TYPE)) %>% 
  dplyr::select(-Gebied, -NAAM_N2K, -TYPE, -BESCHERMIN)

tmp2 <- 
  tmp %>% 
  filter(gebied == "Friese Front") %>% 
  group_by(gebied) %>% 
  summarize(geometry = sf::st_union(geometry)) %>% 
  mutate(bescherming = "KRM + N2000")


ph_natuur_bht <-
  sf::st_intersection(bind_rows(tmp %>% filter(gebied != "Friese Front"), tmp2), 
                      euseamap_nl) %>% 
  
  sf::st_transform(crs=23031) %>%   
  dplyr::mutate(area_km2 = as.numeric(sf::st_area(.)/1000000)) %>% 
  sf::st_transform(crs=4326)  
  # dplyr::select(-OBJECTID) %>% 
  # tibble::rownames_to_column(var="OBJECTID") %>% 
  # mutate(OBJECTID = as.integer(OBJECTID)) %>% 
  # dplyr::select(OBJECTID, SITE_NAME, SITE_TYPE, SITE_REG, krm_ecotoop, MSFD_BBHT, EUNIScombD, area_km2, area_ha)

# ph_natuur_bht %>%
#   ggplot() +
#   theme_publication() +
#   # geom_sf(aes(fill=paste(gebied, bescherming)), linewidth=0.1, alpha=0.4) +
#   geom_sf(aes(fill=krm_ecotoop), linewidth=0.1, alpha=0.4) +
#   geom_sf(data=nl_eez_all, fill=NA, linewidth=0.1, colour="black") +
#   coord_sf(xlim=c(bb[1],bb[3]), ylim=c(bb[2],bb[4]))


# lees de BISI per monsterpunt  
filename <- "BISI berekeningen per BHT tbv Fact Finding v2 MP.xlsx"

bisi_punt <- data.frame(stringsAsFactors = FALSE)

myws <- readxl::excel_sheets(file.path(bisidir, filename))
myws <- myws[grepl("BISI per loc", myws)]

ws <- myws[1]
i = 0

for (ws in myws) {

  i = i + 1
  print(ws)
  
  # read all the data in the worksheet
  full_data <- readxl::read_excel(file.path(bisidir, filename), sheet = ws, col_names = FALSE, .name_repair = "unique_quiet")
  
  # get startrow
  startrow <-
    full_data %>% 
    dplyr::select(1) %>% 
    setNames("tmp") %>% 
    mutate(row=row_number()) %>% 
    filter(tmp == "databundelcode") %>% 
    pull(row)
  
  # get the data block
  df   <-
    full_data %>% 
    filter(row_number() >= startrow) %>% 
    janitor::row_to_names(row_number = 1) %>% 
    janitor::clean_names() %>% 
    dplyr::select(any_of(c("databundelcode",
                           "monsterophaaldatum",
                           "year",
                           "geometriepunt_x",
                           "geometriepunt_y",
                           "meetobject_lokaalid",
                           "grootheid_code",
                           "eenheid_code",
                           "bemonsteringsapparaat_omschrijving",
                           "recordnr_monster",
                           "bemonsterings_techniek",
                           "gebied_code_ecoauthor",
                           "krm_zone",
                           "beoor_deling_at",
                           "beoor_deling_at_asev",
                           "krm_ecotoop",
                           "hr_habitat_sub_type",
                           "bis_ii_algemeen",
                           "bis_ii_fysiek",
                           "sabellaria_spp"))) %>% 
    drop_na(databundelcode) %>% 
    rename(lat = geometriepunt_y, lon = geometriepunt_x, bisi_algemeen=bis_ii_algemeen, bisi_fysiek=bis_ii_fysiek) %>% 
    mutate(across(c("lat","lon", "bisi_algemeen", "bisi_fysiek", "sabellaria_spp"), as.numeric)) %>% 
    mutate(across(c("year"), as.integer)) %>% 
    mutate(year = case_when(
      year == 2014 ~ 2015,
      year == 2019 ~ 2018,
      year == 2017 ~ 2018,
      TRUE         ~ year
    )) %>% 
    mutate(krm_ecotoop = case_when(
      grepl("A5.13|A5.14"            , krm_ecotoop)   ~ "Ondiep grof sediment",
      grepl("A5.15"                  , krm_ecotoop)   ~ "Diep grof sediment",
      grepl("A5.23|A5.24|A5.25|A5.26", krm_ecotoop)   ~ "Ondiep zand",
      grepl("A5.27"                  , krm_ecotoop)   ~ "Diep zand",
      grepl("A5.33|A5.35"            , krm_ecotoop)   ~ "Ondiep slibrijk",
      grepl("A5.37"                  , krm_ecotoop)   ~ "Diep slibrijk",
      TRUE                                            ~ krm_ecotoop
     )) %>% 
    tidyr::pivot_longer(names_to = "bisi_type", values_to = "value", bisi_algemeen:bisi_fysiek) %>% 
    mutate(
      bemonstering = case_when(
        bemonsteringsapparaat_omschrijving %in% c("Bodemschaaf", "Videocamera") ~ "schaaf_video",
        bemonsteringsapparaat_omschrijving %in% c("Box-corer", "Zuigkor", "Hamon happer", "Van Veenhapper") ~ "boxcorer_happer",
        TRUE ~ bemonsteringsapparaat_omschrijving)
    ) %>% 
    mutate(value2 = cut(value, breaks=seq(0, 0.7, 0.05))) %>% 
    sf::st_as_sf(coords = c("lon", "lat"), crs=4326) 
  

    if (i == 1) {
      bisi_punt <- df
    } else {
      bisi_punt <-
        bind_rows(
          bisi_punt,
          df
       ) 
    }
} # Einde van BISI per monsterpunt

# Opslaan van bisi punt data
# bisi_punt %>% 
#   sf::st_drop_geometry() %>% 
#   writexl::write_xlsx(., path=file.path(bisidir, "bisi_punt.xlsx"))

# add the jff gebieden to bisi punt
# bisi_punt <-
#   bisi_punt %>% 
#   # Assign to jff gebieden
#   sf::st_intersection(., jff_comb) %>% 
#   
#   ) 

# bisi_punt %>% ggplot() + geom_sf(aes(size=value))
# bisi_punt %>% group_by(meetobject_lokaalid) %>% summarise(n=n_distinct(bisi_type)) %>% filter(n<2) %>% View()

# lengths(sf::st_intersects(bisi_punt$geometry, jff_bht)) > 0
# l <- sf::st_intersects(bisi_punt$geometry, jff_bht %>% filter(area_km2>1))
# jff_bht %>% filter(area_km2 > 0.1) %>% nrow()

bisi_polygon <-
  bisi_punt %>% 
  mutate(
    OBJECTID = as.integer(sf::st_intersects(geometry, jff_bht))
  ) %>% 
  group_by(bisi_type, bemonstering, krm_ecotoop, year, OBJECTID) %>% 
  summarise(
    nobs = n(), 
    value = mean(value, na.rm=TRUE),
    stdev   = sd(value, na.rm=TRUE)
  ) %>% 
  # mutate(value = ifelse(nobs==1, NA, value)) %>% 
  mutate(value2 = cut(value, breaks=seq(0, 0.7, 0.05))) %>% 
  sf::st_drop_geometry() %>% 
  left_join(jff_bht %>% dplyr::select(OBJECTID, geometry), by="OBJECTID") %>% 
  sf::st_as_sf()

# Bepaal dominant habitat type per WSER grid cel
wsergrid_bht_tmp <-
  sf::st_intersection(wsergrid, euseamap_nl) %>% 
  filter(!is.na(gebied)) %>% 
  
  sf::st_transform(crs=23031) %>%   
  dplyr::mutate(area_km2 = as.numeric(sf::st_area(.)/1000000)) %>% 
  sf::st_transform(crs=4326) %>% 

  sf::st_drop_geometry() %>% 
  
  group_by(gridID, krm_ecotoop) %>% 
  summarise(area_km2 = sum(area_km2, na.rm=TRUE)) %>% 
  
  arrange(gridID, desc(area_km2)) %>% 
  group_by(gridID) %>% 
  dplyr::slice_head(n=1) 

# wsergrid_bht_tmp %>%   group_by(gridID) %>% filter(n()>1) %>% View()
# wsergrid_bht_tmp %>%   arrange(gridID, desc(area_km2)) %>% group_by(gridID) %>% dplyr::slice_head(n=1) 
# wsergrid_bht_tmp %>%   group_by(gridID) %>% summarise(n=n()) %>% filter(n>1) %>% View()
# wsergrid_bht_tmp %>% filter(gridID %in% c(55820,55821, 55822, 56061, 55581)) %>% View()

# wsergrid_bht_tmp %>% 
#   ggplot() +
#   theme_publication() +
#   geom_sf(aes(fill=krm_ecotoop), linewidth=0.1, alpha=0.4) +
#   # geom_sf(fill=NA, linewidth=0.1, alpha=0.4) +
#   # geom_sf(data = euseamap_nl, aes(fill=krm_ecotoop), linewidth=0.1, alpha=0.4) +
#   geom_sf(data=jff_comb, fill=NA, linewidth=0.1, colour="black") +
#   coord_sf(ylim=c(55,55.5), xlim=c(3,5)) 


wsergrid_bht <-
  wsergrid %>% 
  left_join(wsergrid_bht_tmp, by="gridID") %>% 
  drop_na(krm_ecotoop)

# wsergrid_bht %>%   group_by(gridID) %>% summarise(n=n()) %>% filter(n>1) %>% View()
# wsergrid_bht %>%   group_by(gridID) %>% filter(n()>1) %>% View()

# wsergrid_bht %>% 
#   ggplot() +
#   theme_publication() +
#   geom_sf(aes(fill=krm_ecotoop), linewidth=0.1, alpha=0.4) +
#   geom_sf_text(aes(label=gridID), size=3) +
#   geom_sf(data=jff_comb, fill=NA, linewidth=0.1, colour="black") +
#   coord_sf(ylim=c(55,55.8), xlim=c(3,5)) 

# export wsergrid_bht
# nm <- unique(wsergrid_bht$gebied)[5]
# for (nm in unique(wsergrid_bht$gebied)) {
#   
#   t <- 
#     wsergrid_bht %>% 
#     sf::st_drop_geometry() %>%
#     dplyr::select(-gridID, -area_km2) %>% 
#     filter(gebied == nm) %>% 
#     dplyr::select(-gebied) %>% 
#     arrange(kolom) %>% 
#     tidyr::pivot_wider(names_from = kolom, values_from = krm_ecotoop) %>% 
#     arrange(rij)
# 
#   writexl::write_xlsx(t, path=file.path(wserdir, paste0("WSER gebieden",nm," v2.xlsx")))
# }


# Assign bisi_punt to wser grid
wsergrid_bisi <-
  bisi_punt %>% 
  
  # intersects process
  mutate(objectID = sf::st_intersects(geometry, wsergrid_bht)) %>% 
  
  # select first polygon
  mutate(objectID = purrr::map_int(objectID, ~ if(length(.) > 0) .[1] else NA_integer_))  %>% 
  
  # select random polygon
  # mutate(objectID = purrr::map_int(objectID, ~ if(length(.) > 0) sample(., 1) else NA_integer_))  %>% 
  drop_na(objectID) %>% 
  
  group_by(bisi_type, bemonstering, year, objectID) %>% 
  # group_by(bisi_type, krm_ecotoop, year, objectID) %>% 
  # group_by(bisi_type, bemonstering, krm_ecotoop, year, objectID) %>% 
  summarise(
    nobs = n(), 
    value = mean(value, na.rm=TRUE),
    stdev   = sd(value, na.rm=TRUE)
  ) %>% 
  # mutate(value = ifelse(nobs==1, NA, value)) %>% 
  mutate(value2 = cut(value, breaks=seq(0, 0.7, 0.05))) %>% 
  sf::st_drop_geometry() %>% 
  left_join(wsergrid_bht %>% 
              rownames_to_column(var="objectID") %>%
              mutate(objectID = as.integer(objectID)) %>% 
              dplyr::select(objectID, gridID, gebied, geometry), 
            by="objectID") %>% 
  sf::st_as_sf()



# Write WSERGRID bisi to excel
i <- 1
nm <- unique(wsergrid_bht$gebied)[i]

c <- 0
for (nm in unique(wsergrid_bht$gebied)) {
  
  c <- c + 1
  
  t <-
    wsergrid_bisi %>%
    ungroup() %>% 
    filter(gebied == nm, bisi_type=="bisi_algemeen", year=="2021") %>% 
    sf::st_drop_geometry() %>%
    
    # @@ make sure only one observation in each rect; e.g. summarize over methods
    
    dplyr::select(-objectID, -bisi_type, -stdev, -value2, -nobs, -year) %>% 
    left_join(wsergrid %>% sf::st_drop_geometry(), 
              by=c("gridID", "gebied")) %>% 
    dplyr::select(-gridID, -gebied) 
  
  tmp <- data.frame()
  for (i in 1:max(t$rij)) {
    for (j in 1:max(t$kolom)) {
      tmp <-
        bind_rows(
        tmp,
        data.frame(rij=i, kolom=j)
      )
    }
  }

  t2 <-
    tmp %>% 
    left_join(t, by=c("rij","kolom")) %>% 
    arrange(kolom) %>% 
    tidyr::pivot_wider(names_from = kolom, values_from = value) %>% 
    arrange(rij)
  
  if (c==1) {
    print(paste(c, nm, "if"))
    listed_df <- list(t2)
  } else {
    print(paste(c, nm, "else"))
    listed_df <- c(listed_df, list(t2))
  }
}
names(listed_df) <- unique(wsergrid_bht$gebied)
writexl::write_xlsx(listed_df, path=file.path(wserdir, "WSER gebieden met BISI scores.xlsx"))

# wsergrid_bisi %>% group_by(objectID) %>% filter(meetobject_lokaalid == "NL80_NRDZE_0128") %>% 
#   ggplot() + theme_publication() + geom_sf(aes(fill=krm_ecotoop))

# wsergrid_bht %>% rownames_to_column(var="objectID") %>% mutate(objectID=as.integer(objectID)) %>% filter(objectID %in% c(958)) %>%
#   ggplot() + theme_publication() + geom_sf(aes(colour=krm_ecotoop), fill=NA) + geom_sf(data=wsergrid_bisi %>% filter(objectID==958), aes(fill=value2)) + facet_wrap(~year) # filter(meetobject_lokaalid=="NL80_NRDZE_0128"))

# ggplot() + theme_publication() + geom_sf(data=wsergrid_bisi, aes(fill=value2)) + facet_wrap(~year) # 

# wsergrid_bisi_tmp <-
#   bisi_polygon %>% 
#   sf::st_intersection(., wsergrid_bht) %>% 
#   dplyr::select(-area_km2) %>% 
#   
#   sf::st_transform(crs=23031) %>%   
#   dplyr::mutate(area_km2 = as.numeric(sf::st_area(.)/1000000)) %>% 
#   sf::st_transform(crs=4326) %>% 
# 
#   sf::st_drop_geometry() %>% 
#   filter(krm_ecotoop == krm_ecotoop.1) %>% 
#   dplyr::select(-krm_ecotoop.1, -OBJECTID, -gebied, -rij, -kolom) 
  # group_by(gridID, value, value2) %>% 
  # summarise(area_km2 = sum(area_km2, na.rm=TRUE)) %>% 
  # 
  # arrange(gridID, desc(area_km2)) %>% 
  # group_by(gridID) %>% 
  # dplyr::slice_head(n=1) %>% 
  # drop_na(value)

# wsergrid_bisi_tmp %>% filter(OBJECTID==19246) %>% View()
# wsergrid_bht %>% filter(gridID==19246) %>% View()

# wsergrid_bisi <-
#   wsergrid_bisi_tmp %>% 
#   left_join(wsergrid, by="gridID") %>% 
#   sf::st_as_sf()



# wsergrid_bisi %>% filter(nobs > 1) %>% ungroup() %>% View()
# wsergrid_bisi %>% sf::st_drop_geometry() %>%
#   filter(meetobject_lokaalid=="NL80_IMA2017_42858") %>%
#   View()
  # group_by(year, meetobject_lokaalid, bisi_type) %>%
  # dplyr::slice_head(n=1) %>%  View()

# tmp %>% sf::st_drop_geometry() %>%  group_by(meetobject_lokaalid) %>% summarise(n=n()) %>% filter(n>1) %>% View()
# tmp %>% filter(meetobject_lokaalid=="IMA2015_19234") %>% View()
# tmp %>% 
#   filter(meetobject_lokaalid=="IMA2015_19234") %>% 
#   ggplot() +
#   theme_publication() +
#   geom_sf(aes(colour=gridID)) +
#   geom_sf(data=wsergrid %>% filter(gridID %in% c(42174, 42175, 42414, 42415)), fill=NA)

# Assign bisi_punt to wser grid
natuurgebied_bisi <-
  bisi_punt %>% 
  
  # intersects process
  mutate(objectID = sf::st_intersects(geometry, jff_bht)) %>% 
  
  # select first polygon
  mutate(objectID = purrr::map_int(objectID, ~ if(length(.) > 0) .[1] else NA_integer_))  %>% 
  
  # select random polygon
  # mutate(objectID = purrr::map_int(objectID, ~ if(length(.) > 0) sample(., 1) else NA_integer_))  %>% 
  drop_na(objectID) %>% 
  
  group_by(bisi_type, bemonstering, year, objectID) %>% 
  # group_by(bisi_type, krm_ecotoop, year, objectID) %>% 
  # group_by(bisi_type, bemonstering, krm_ecotoop, year, objectID) %>% 
  summarise(
    nobs = n(), 
    value = mean(value, na.rm=TRUE),
    stdev   = sd(value, na.rm=TRUE)
  ) %>% 
  sf::st_drop_geometry() %>% 
  
  # mutate(value = ifelse(nobs==1, NA, value)) %>% 
  left_join(jff_bht %>% 
              rownames_to_column(var="objectID") %>%
              mutate(objectID = as.integer(objectID)) %>% 
              dplyr::select(objectID, krm_ecotoop, SITE_NAME, SITE_REG, geometry), 
            by="objectID") %>% 
  sf::st_as_sf() %>% 
  sf::st_drop_geometry() %>% 
  group_by(bisi_type, bemonstering, year, SITE_NAME, SITE_REG) %>% 
  summarise(value = weighted.mean(value, nobs))


# natuurgebied_bisi %>% 
#   filter(bisi_type=="bisi_algemeen", bemonstering=="schaaf_video", year=="2021") %>% 
#   arrange(desc(value)) %>% 
#   View()


# x <- sf::read_sf(file.path(shapedir, "Maritiem Ruimtelijk Plan-kaart Ontwerp-PH Programma Noordzee 2022-2027.mapx"))

# Lees de BISI lange termijn trends
bisi_trend_bht <- 
  readxl::read_excel(file.path(bisidir, "BISI trends T1 obv BISIv3 BHT.xlsx"), col_names = TRUE) %>% 
  lowcase()

bisi_trend_mpa <- 
  readxl::read_excel(file.path(bisidir, "BISI trends T1 obv BISIv3 MPA.xlsx"), col_names = TRUE) %>% 
  lowcase()

# habitats in EEZ
habitats_in_eez <-
  euseamap_nl %>% 
  sf::st_drop_geometry() %>%
  group_by(krm_ecotoop) %>%
  summarise(
    area_km2 = sum(area_km2, na.rm=TRUE)
  ) 

# habitats reeds gesloten  
habitats_reeds_beschermd <-
  jff_bht %>% 
  sf::st_drop_geometry() %>%
  filter(SITE_REG %in% c("fishery restricted","fishery restriction proposed")) %>% 
  group_by(krm_ecotoop) %>%
  summarise(
    area_km2 = sum(area_km2, na.rm=TRUE)
  ) 

# read scenario results: moved to the lower sections of the code

  
# set bounding boxes
bb          <- sf::st_bbox(euseamap_nl)
bb_gebieden <- readxl::read_excel(file.path(datadir, "gebieden.xlsx"), col_names = TRUE)

```

# JFF rapportage voor NZO

28 mei 2025

*Overzicht van N2000/KRM gebieden in NL deel van Noordzee*

```{r, fig.asp=1.2, echo=FALSE, message=FALSE, warning=FALSE, comment=NA}

ggplot() +
  theme_publication() +
  geom_sf(data= jff_comb %>% filter(SITE_NAME %notin% c("EEZ", "Doggerbank 619")), 
          fill="gray20", linewidth=0.2, alpha=0.4) +
  geom_sf(data= jff_comb %>% filter(SITE_REG != "open" & SITE_NAME != "Doggerbank 619"), 
          aes(fill=SITE_REG), linewidth=0.2, alpha=0.4) +
  geom_sf(data= jff_comb %>% filter(SITE_NAME %in% c("Doggerbank 619")), 
          fill=NA, linewidth=0.2, alpha=0.4) +
  geom_sf(data=nl_eez_all, fill=NA) +
  guides(fill = guide_legend(nrow = 1)) +
  coord_sf(xlim=c(bb[1],bb[3]), ylim=c(bb[2],bb[4])) 
  

# xlim <- as.numeric(bb_gebieden[3,2:3])
# ylim <- as.numeric(bb_gebieden[3,4:5])
# 
# jff_comb %>% 
#   ggplot() +
#   theme_tufte() +
#   geom_sf(data=wsergrid_bht, aes(fill=krm_ecotoop), linewidth=0.3) +
#   geom_sf(fill=NA, linewidth=0.8, colour="red") +
#   coord_sf(xlim=xlim, ylim=ylim)  

```
\newpage

*Overzicht van diverse gebruik op de Noordzee*

```{r, fig.asp=1.2, echo=FALSE, message=FALSE, warning=FALSE, comment=NA}

t <-
  bind_rows(
    ph_zandwinning %>% dplyr::select(geometry) %>% mutate(gebruik = "PH reservering zandwinning"),
    ph_windenergie %>% dplyr::select(geometry) %>% mutate(gebruik = "PH windenergie"),
    ph_scheepvaart %>% dplyr::select(geometry) %>% mutate(gebruik = "PH scheepvaart clearways"),
    nlog           %>% dplyr::select(geometry) %>% mutate(gebruik = "NL Olie & Gas"),
    jff_comb       %>% filter(SITE_NAME %notin% c("EEZ", "Doggerbank 619", "FF viss1", "FF viss2")) %>% dplyr::select(geometry) %>% mutate(gebruik = "N2000/KRM"),
  )

ggplot() +
  theme_publication() +
  theme(legend.position = "right", legend.direction = "vertical") +
  geom_sf(data = nl_eez_all, fill=NA, colour="red", alpha=0.5) +
  
  geom_sf(data=t, aes(fill=gebruik, colour=gebruik), alpha=0.5, size=1) 
  # geom_sf(data = ph_zandwinning, fill="yellow", colour="yellow4", alpha=0.5) +
  # geom_sf(data = ph_windenergie, fill="brown", colour="brown4", alpha=0.5) +
  # geom_sf(data = ph_scheepvaart, fill="blue", colour="blue", alpha=0.5) +
  # geom_sf(data= jff_comb %>% filter(SITE_NAME %notin% c("EEZ", "Doggerbank 619")), 
  #         fill="gray20", linewidth=0.2, alpha=0.4) +
  # geom_sf(data= jff_comb %>% filter(SITE_REG != "open" & SITE_NAME != "Doggerbank 619"), 
  #         aes(fill=SITE_REG), linewidth=0.2, alpha=0.4) +
  # geom_sf(data= jff_comb %>% filter(SITE_NAME %in% c("Doggerbank 619")), 
  #         fill=NA, linewidth=0.2, alpha=0.4) +
  # geom_sf(data=nlog %>% filter(STATUS=="In gebruik"), colour="blue")



```



```{r, fig.asp=1.0, echo=FALSE, message=FALSE, warning=FALSE, comment=NA}

bisi_punt %>%
  filter(value < 0.5) %>% 
  # filter(bisi_type=="bisi_algemeen") %>% 
  
  ggplot() +
  theme_publication() +
  geom_sf(data=world_mr_sf, fill=NA) +
  geom_sf(data=nl_eez_all, fill=NA) +
  geom_sf(data=jff_comb, colour="black", fill=NA) +
  geom_sf(aes(colour=krm_ecotoop, size=value), alpha=0.5) +
  coord_sf(xlim=c(bb[1],bb[3]), ylim=c(bb[2],bb[4])) +
  # labs(title="BISI algemeen") +
  facet_grid(year ~ bisi_type+bemonstering)

xlim <- as.numeric(bb_gebieden[1,2:3])
ylim <- as.numeric(bb_gebieden[1,4:5])

bisi_punt %>%
  filter(value < 0.5) %>% 
  filter(year==2021) %>% 
  
  ggplot() +
  theme_publication() +
  geom_sf(data=world_mr_sf, fill=NA) +
  geom_sf(data=nl_eez_all, fill=NA) +
  geom_sf(data=jff_comb, colour="black", fill=NA) +
  geom_sf(aes(colour=krm_ecotoop, size=value), alpha=0.5) +
  coord_sf(xlim=xlim, ylim=ylim) +
  facet_grid(bisi_type~bemonstering)

bisi_punt %>%
  sf::st_drop_geometry() %>% 
  filter(value < 0.5) %>% 
  filter(bisi_type=="bisi_algemeen") %>% 
  group_by(year, krm_ecotoop, bemonstering) %>% 
  summarise(nobs = n()) %>% 
  
  ggplot(aes(x=krm_ecotoop, y=nobs, fill=bemonstering, group=bemonstering)) +
  theme_publication() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  geom_bar(stat="identity", position="dodge") +
  labs(x="") +
  facet_wrap(~year)


# bisi_punt %>%
#   filter(value < 0.5) %>% 
#   filter(bisi_type=="bisi_algemeen") %>% 
#   
#   ggplot() +
#   theme_publication() +
#   geom_sf(data=world_mr_sf, fill=NA) +
#   geom_sf(data=nl_eez_all, fill=NA) +
#   geom_sf(data=jff_comb, colour="black", fill=NA) +
#   geom_sf(aes(colour=krm_ecotoop, size=value), alpha=0.5) +
#   coord_sf(xlim=c(bb[1],bb[3]), ylim=c(bb[2],bb[4])) +
#   labs(title="BISI algemeen") +
#   facet_grid(bemonstering~year)


bisi_punt %>%
  sf::st_drop_geometry() %>% 
  filter(value < 0.5) %>% 
  # filter(bisi_type=="bisi_algemeen") %>% 
  dplyr::select(meetobject_lokaalid, year, krm_ecotoop, bisi_type, bemonstering, value) %>% 
  tidyr::pivot_wider(names_from = bemonstering, values_from = value) %>% 
  filter(!is.na(boxcorer_happer) & !is.na(schaaf_video)) %>% 
           
  ggplot(aes(x=boxcorer_happer, y=schaaf_video, colour=krm_ecotoop )) +
  theme_publication() +
  geom_point() +
  geom_smooth(method="lm", se=F) +
  labs(title="Vergelijking bemonstering") +
  guides(colour = guide_legend(nrow = 1)) +
  facet_wrap(~bisi_type)
  

bisi_punt %>%
  sf::st_drop_geometry() %>% 
  filter(value < 0.5) %>% 
  # filter(bemonstering=="boxcorer_happer") %>% 
  dplyr::select(meetobject_lokaalid, year, krm_ecotoop, bemonstering, bisi_type, value) %>% 
  tidyr::pivot_wider(names_from = bisi_type, values_from = value) %>% 

  ggplot(aes(x=bisi_algemeen, y=bisi_fysiek, colour=krm_ecotoop )) +
  theme_publication() +
  geom_point() +
  geom_smooth(method="lm", se=F) +
  labs(title="vergelijking bisi type") +
  guides(colour = guide_legend(nrow = 1)) +
  facet_wrap(~bemonstering)





```

\newpage

*WSER grid met dominante habitat types*

```{r, fig.asp=1.2, echo=FALSE, message=FALSE, warning=FALSE, comment=NA}
p0 <-
  ggplot() +
  theme_publication() +
  geom_sf(data= jff_comb %>% filter(SITE_NAME != "EEZ"), 
          fill="gray", linewidth=0.1, alpha=0.4) +
  geom_sf(data= jff_comb %>% filter(SITE_REG != "open" & SITE_NAME != "Doggerbank 619"), 
          aes(fill=SITE_REG), linewidth=0.1, alpha=0.4) +
  geom_sf(data=nl_eez_all, fill=NA) +
  guides(fill = guide_legend(nrow = 1)) +
  coord_sf(xlim=c(bb[1],bb[3]), ylim=c(bb[2],bb[4])) 
  
p1 <- 
  wsergrid_bht %>% 
  ggplot() +
  theme_publication() +
  geom_sf(fill=NA, linewidth=0.1, alpha=0.4) +
  geom_sf(data = euseamap_nl, aes(fill=krm_ecotoop), linewidth=0.1, alpha=0.4) +
  geom_sf(data=jff_comb, fill=NA, linewidth=0.1, colour="black") +
  guides(fill = guide_legend(nrow = 1)) +
  coord_sf(xlim=c(bb[1],bb[3]), ylim=c(bb[2],bb[4])) 

g <- ggplot_build(p1)
unique(g$data[[2]]["fill"])

p2 <- 
  wsergrid_bht %>% 
  ggplot() +
  theme_publication() +
  geom_sf(aes(fill=krm_ecotoop), linewidth=0.1, alpha=1.0) +
  geom_sf(data=jff_comb, fill=NA, linewidth=0.1, colour="black") +
  guides(fill = guide_legend(nrow = 1)) +
  coord_sf(xlim=c(bb[1],bb[3]), ylim=c(bb[2],bb[4])) 

p1 + p2 + 
plot_layout(nrow = 1, guides="collect") &
theme(legend.position='bottom') &
theme(plot.margin = unit(c(0,0,0,0), "cm")) 


```
\newpage

*Overzicht van gebieden, vakken en BISI waardes (2021, BISI algemeen)*

```{r, fig.asp=0.4, echo=FALSE, message=FALSE, warning=FALSE, comment=NA}

g <- bb_gebieden$Naam[3]
i <- 0 

for (g in bb_gebieden$Naam) {
  
  xlim <- as.numeric(bb_gebieden[bb_gebieden$Naam == g,2:3])
  ylim <- as.numeric(bb_gebieden[bb_gebieden$Naam == g,4:5])
  i <- i + 1
  
  assign(paste0("p",i),
    bisi_punt %>% 
      filter(bisi_type=="bisi_algemeen", year==2021) %>% 
      ggplot() +
      theme_publication() +
      # geom_sf(data=world_mr_sf, fill=NA) +
      geom_sf(data = nl_eez_all, fill=NA) +
      geom_sf(data = jff_comb, fill=NA, linewidth=1, colour="black") +
      geom_sf(data = wsergrid, color = "gray50", fill=NA, linewidth=0.1) +
      # geom_sf_text(data = wsergrid, aes(label=gridID), color = "gray50", size=2) +
      geom_sf(data = euseamap_nl, aes(fill=krm_ecotoop), linewidth=0.1, alpha=0.4) +
      geom_sf(aes(colour=krm_ecotoop, size=value), alpha=0.5, show.legend = FALSE) +
      
      geom_sf(data = ph_zandwinning, fill="yellow", colour="yellow", alpha=0.5) +
      geom_sf(data = ph_windenergie, fill="green", colour="green", alpha=0.5) +
      geom_sf(data = ph_scheepvaart, fill="blue", colour="blue", alpha=0.5) +
      geom_sf(data = jff_comb %>% filter(SITE_REG %in% c("fishery restricted","fishery restriction proposed")), fill="gray", alpha=0.5) +
    
      # labs(title=paste("BISI algemeen /", g)) +
      labs(title=paste(g)) +
      coord_sf(xlim=xlim, ylim=ylim) + 
      labs(x="", y="") +
      guides(fill = guide_legend(nrow = 1)) 
      # facet_wrap(~year, nrow=1)
  )
  
}

p1 + p2 + p3 + p4 + p5 + p6 +
plot_layout(nrow = 1, guides="collect") &
theme(legend.position='bottom') &
theme(plot.margin = unit(c(0,0,0,0), "cm")) 
# print(p)


```

\newpage

*Overzicht van visserijbeperkingen (geldend of reeds ingebracht) per habitattype*

```{r, fig.asp=1.2, echo=FALSE, message=FALSE, warning=FALSE, comment=NA}

tmp <-
  jff_bht %>% 
  sf::st_drop_geometry() %>%
  mutate(SITE_REG = ifelse(SITE_REG %in% c("fishery restriction suggested"), "open", SITE_REG)) %>% 
  mutate(SITE_REG = ifelse(SITE_REG %in% c("fishery restricted","fishery restriction proposed"), "visserij gesloten/in procedure", SITE_REG)) %>% 
  group_by(SITE_REG, krm_ecotoop) %>%
  summarise(
    area_km2 = sum(area_km2, na.rm=TRUE)
  ) %>%
  group_by(krm_ecotoop) %>%
  mutate(prop = area_km2 / sum(area_km2)) %>% 
  mutate(prop = scales::percent(prop, accuracy=0.1)) %>% 
  mutate(area_km2 = as.integer(area_km2)) 


tmp %>% 
  reshape2::dcast(SITE_REG ~ krm_ecotoop, value.var = "area_km2", sum, margins=c("SITE_REG", "krm_ecotoop")) %>% 
  pander::pandoc.table(.,
               style = "simple",
               split.tables=400, 
               justify = "right",
               missing=".",
               round=c(0))

tmp %>% 
  reshape2::dcast(SITE_REG ~ krm_ecotoop, value.var = "prop") %>% 
  pander::pandoc.table(.,
               style = "simple",
               split.tables=400, 
               justify = "right",
               missing=".",
               round=c(0))

ft <-
  tmp %>% 
  reshape2::dcast(SITE_REG ~ krm_ecotoop, value.var = "prop") %>% 
  flextable::flextable() %>%
  flextable::fontsize(size = 12, part = "all") %>% 
  flextable::colformat_num(j=1, big.mark="") %>% 
  flextable::bold(part="header", bold=TRUE) %>% 
  flextable::bold(i=c(nrow(.data)), bold=TRUE) %>% 
  flextable::align(j=1:2, align="right", part="all") %>% 
  flextable::autofit()

# png(filename=file.path(tablesdir, "haul overview by month.png"),
#     width=9.3, height=2.7, units="in", res=300, bg="transparent")
# plot(ft, fit = "fixed", just = "left")
# dev.off()

print(ft)


```

```{r, fig.asp=1.2, echo=FALSE, message=FALSE, warning=FALSE, comment=NA}

# habitats per natuurgebied

tmp1 <-
  euseamap_nl %>% 
  sf::st_drop_geometry() %>%
  group_by(krm_ecotoop) %>%
  summarise(
    area_km2 = sum(area_km2, na.rm=TRUE)
  ) %>%
  mutate(gebied = "EEZ")
  
tmp2 <-
  ph_natuur_bht %>% 
  sf::st_drop_geometry() %>%
  group_by(gebied, krm_ecotoop) %>%
  summarise(
    area_km2 = sum(area_km2, na.rm=TRUE)
  ) 

tmp3 <-
  tmp2 %>% 
  group_by(krm_ecotoop) %>%
  group_by(krm_ecotoop) %>%
  summarise(
    area_km2 = sum(area_km2, na.rm=TRUE)
  ) %>%
  mutate(gebied = "natuur") %>% 
  bind_rows(tmp1) %>% 
  pivot_wider(names_from = gebied, values_from = area_km2) %>% 
  mutate(ZZZ_EEZ = EEZ - natuur) %>% 
  dplyr::select(-EEZ, -natuur) %>% 
  pivot_longer(names_to = "gebied", values_to = "area_km2", ZZZ_EEZ) %>% 
  
  bind_rows(tmp2) %>% 
  group_by(krm_ecotoop) %>% 
  mutate(prop = area_km2 / sum(area_km2)) %>% 
  mutate(perc = scales::percent(prop, accuracy=0.1)) %>% 
  mutate(area_km2 = as.integer(area_km2)) 

tmp3 %>% 
  reshape2::dcast(gebied ~ krm_ecotoop, value.var = "area_km2", sum, margins=c("gebied", "krm_ecotoop")) %>% 
  pander::pandoc.table(.,
               style = "simple",
               split.tables=400, 
               justify = "right",
               missing=".",
               round=c(0))

tmp3 %>% 
  reshape2::dcast(gebied ~ krm_ecotoop, value.var = "area_km2", sum, margins=c("gebied", "krm_ecotoop")) %>% 
  writexl::write_xlsx(., path=file.path(datadir, "habitat oppervlak per natuurgebied.xlsx"))
# jff_comb %>% filter(grepl("Dogger", SITE_NAME)) %>% ggplot() + theme_publication() + geom_sf(aes(fill=SITE_NAME))

```
\newpage

*Oppervlak op het Friese Front*

```{r, fig.asp=1.2, echo=FALSE, message=FALSE, warning=FALSE, comment=NA}

g <- bb_gebieden$Naam[4]

xlim <- as.numeric(bb_gebieden[bb_gebieden$Naam == g,2:3])
ylim <- as.numeric(bb_gebieden[bb_gebieden$Naam == g,4:5])

jff_bht %>% 
  # sf::st_drop_geometry() %>% 
  # group_by(SITE_NAME, SITE_REG, krm_ecotoop) %>% 
  # summarise(
  #   area_km2 = sum(area_km2, na.rm=TRUE)
  # ) %>% 
  # View()
  filter(area_km2 >= 20) %>% 
  ggplot() +
    theme_publication() +
    geom_sf(data=jff_comb, fill=NA, linewidth=1, colour="black") +
    geom_sf(data = euseamap_nl, aes(fill=krm_ecotoop), linewidth=0.1, alpha=0.4) +
    geom_sf_text(aes(label=as.integer(area_km2))) +
    coord_sf(xlim=xlim, ylim=ylim)  



```

*Overzicht BISI waardes (2021, BISI algemeen, schaaf/video)*

```{r, fig.asp=1.2, echo=FALSE, message=FALSE, warning=FALSE, comment=NA}

t1 <- bisi_punt %>% filter(bisi_type=="bisi_algemeen", year == 2021, bemonstering=="schaaf_video") 

ggplot() +
  theme_publication() +
  # geom_sf(data=world_mr_sf, fill=NA) +
  geom_sf(data = nl_eez_all, fill=NA) +
  geom_sf(data = jff_comb, fill=NA, linewidth=1, colour="black") +
  geom_sf(data = euseamap_nl, aes(fill=krm_ecotoop), linewidth=0.1, alpha=0.5) +
  geom_sf(data = t1, aes(size=value), colour="blue", alpha=0.8) +
  
  geom_sf(data = ph_zandwinning, fill="yellow", colour="yellow", alpha=0.2) +
  geom_sf(data = ph_windenergie, fill="green", colour="green", alpha=0.2) +
  geom_sf(data = ph_scheepvaart, fill="blue", colour="blue", alpha=0.2) +
  geom_sf(data = jff_comb %>% filter(SITE_REG %in% c("fishery restricted","fishery restriction proposed")), fill="gray", alpha=0.5) +

  # labs(title=paste("BISI algemeen /", g)) +
  labs(title="BISI algemeen 2021") +
  labs(x="", y="") +
  guides(fill = guide_legend(nrow = 1)) +
  scale_size_continuous(range=c(0.5, 3)) +
  coord_sf(xlim=c(bb[1],bb[3]), ylim=c(bb[2],bb[4])) 

  # facet_wrap(~year, nrow=1)


```


*Overzicht van gebieden en BISI waardes (2021, BISI algemeen, schaaf/video)*

```{r, fig.asp=0.4, echo=FALSE, message=FALSE, warning=FALSE, comment=NA}

g <- bb_gebieden$Naam[3]
i <- 0 

t1 <- bisi_punt %>% filter(bisi_type=="bisi_algemeen", year == 2021, bemonstering=="schaaf_video") 

for (g in bb_gebieden$Naam) {
  
  xlim <- as.numeric(bb_gebieden[bb_gebieden$Naam == g,2:3])
  ylim <- as.numeric(bb_gebieden[bb_gebieden$Naam == g,4:5])
  i <- i + 1
  

  assign(paste0("p",i),
    ggplot() +
      theme_publication() +
      # geom_sf(data=world_mr_sf, fill=NA) +
      geom_sf(data = nl_eez_all, fill=NA) +
      geom_sf(data = jff_comb, fill=NA, linewidth=1, colour="black") +
      geom_sf(data = euseamap_nl, aes(fill=krm_ecotoop), linewidth=0.1, alpha=0.5) +
      geom_sf(data = t1, aes(size=value), colour="blue", alpha=0.5) +
      
      # geom_sf(data = ph_zandwinning, fill="yellow", colour="yellow", alpha=0.2) +
      # geom_sf(data = ph_windenergie, fill="green", colour="green", alpha=0.2) +
      # geom_sf(data = ph_scheepvaart, fill="blue", colour="blue", alpha=0.2) +
      geom_sf(data = jff_comb %>% filter(SITE_REG %in% c("fishery restricted","fishery restriction proposed")), fill="gray", alpha=0.5) +
    
      # labs(title=paste("BISI algemeen /", g)) +
      labs(title=paste(g)) +
      coord_sf(xlim=xlim, ylim=ylim) + 
      labs(x="", y="") +
      scale_size_continuous(range=c(0.5, 3)) +
      guides(fill = guide_legend(nrow = 1)) 
      # facet_wrap(~year, nrow=1)
  )
  
}

p1 + p2 + p3 + p4 + p5 + p6 + 
plot_layout(nrow = 1, guides="collect") &
theme(legend.position='bottom') &
theme(plot.margin = unit(c(0,0,0,0), "cm")) 

```


*Overzicht van gebieden, vakken en BISI waardes (2021, BISI algemeen)*

```{r, fig.asp=0.4, echo=FALSE, message=FALSE, warning=FALSE, comment=NA}

g <- bb_gebieden$Naam[3]
i <- 0 

t1 <- wsergrid_bisi %>% filter(bisi_type=="bisi_algemeen", year == 2021, bemonstering == "schaaf_video") %>% sf::st_centroid(.)

for (g in bb_gebieden$Naam) {
  
  xlim <- as.numeric(bb_gebieden[bb_gebieden$Naam == g,2:3])
  ylim <- as.numeric(bb_gebieden[bb_gebieden$Naam == g,4:5])
  i <- i + 1
  

  assign(paste0("p",i),
    ggplot() +
      theme_publication() +
      # geom_sf(data=world_mr_sf, fill=NA) +
      geom_sf(data = nl_eez_all, fill=NA) +
      geom_sf(data = jff_comb, fill=NA, linewidth=1, colour="black") +
      geom_sf(data = wsergrid_bht, aes(fill=krm_ecotoop), linewidth=0.1, alpha=0.5) +
      # geom_sf_text(data = wsergrid_bht, aes(label=gridID), color = "gray50", size=2) +
      geom_sf(data = t1, aes(size=value), colour="blue", alpha=1) +
      
      # geom_sf(data = ph_zandwinning, fill="yellow", colour="yellow", alpha=0.2) +
      # geom_sf(data = ph_windenergie, fill="green", colour="green", alpha=0.2) +
      # geom_sf(data = ph_scheepvaart, fill="blue", colour="blue", alpha=0.2) +
      geom_sf(data = jff_comb %>% filter(SITE_REG %in% c("fishery restricted","fishery restriction proposed")), fill="gray", alpha=0.5) +
    
      # labs(title=paste("BISI algemeen /", g)) +
      labs(title=paste(g)) +
      coord_sf(xlim=xlim, ylim=ylim) + 
      labs(x="", y="") +
      scale_size_continuous(range=c(0.5, 3)) +
      guides(fill = guide_legend(nrow = 1)) 
      # facet_wrap(~year, nrow=1)
  )
  
}

p1 + p2 + p3 + p4 + p5 + p6 +
plot_layout(nrow = 1, guides="collect") &
theme(legend.position='bottom') &
theme(plot.margin = unit(c(0,0,0,0), "cm")) 
# print(p)


```

*Overzicht van Sabellaria aantallen in gebieden (2021)*

```{r, fig.asp=0.4, echo=FALSE, message=FALSE, warning=FALSE, comment=NA}

g <- bb_gebieden$Naam[3]
i <- 0 

t1 <- bisi_punt %>% filter(bisi_type=="bisi_algemeen", year == 2021) 

for (g in bb_gebieden$Naam) {
  
  xlim <- as.numeric(bb_gebieden[bb_gebieden$Naam == g,2:3])
  ylim <- as.numeric(bb_gebieden[bb_gebieden$Naam == g,4:5])
  i <- i + 1
  

  assign(paste0("p",i),
    ggplot() +
      theme_publication() +
      # geom_sf(data=world_mr_sf, fill=NA) +
      geom_sf(data = nl_eez_all, fill=NA) +
      geom_sf(data = jff_comb, fill=NA, linewidth=1, colour="black") +
      geom_sf(data = wsergrid_bht, aes(fill=krm_ecotoop), linewidth=0.1, alpha=0.5) +
      # geom_sf_text(data = wsergrid_bht, aes(label=gridID), color = "gray50", size=2) +
      geom_sf(data = t1, aes(size=sabellaria_spp), colour="blue", alpha=1) +
      
      # geom_sf(data = ph_zandwinning, fill="yellow", colour="yellow", alpha=0.2) +
      # geom_sf(data = ph_windenergie, fill="green", colour="green", alpha=0.2) +
      # geom_sf(data = ph_scheepvaart, fill="blue", colour="blue", alpha=0.2) +
      geom_sf(data = jff_comb %>% filter(SITE_REG %in% c("fishery restricted","fishery restriction proposed")), fill="gray", alpha=0.5) +
    
      # labs(title=paste("BISI algemeen /", g)) +
      labs(title=paste(g)) +
      coord_sf(xlim=xlim, ylim=ylim) + 
      labs(x="", y="") +
      scale_size_continuous(range=c(0.5, 3)) +
      guides(fill = guide_legend(nrow = 1)) 
      # facet_wrap(~year, nrow=1)
  )
  
}

p1 + p2 + p3 + p4 + p5 + p6 +
plot_layout(nrow = 1, guides="collect") &
theme(legend.position='bottom') &
theme(plot.margin = unit(c(0,0,0,0), "cm")) 
# print(p)


```






```{r, fig.asp=1.2, echo=FALSE, message=FALSE, warning=FALSE, comment=NA}

bisi_trend_bht %>% 
  filter(!grepl("KRM", sampling)) %>% 
  filter(indicator == "General quality") %>% 
  ggplot(aes(x=year, y=value, group=sampling)) +
  theme_publication() +
  geom_point(aes(colour=sampling, shape=sampling)) +
  geom_smooth(aes(colour=sampling), alpha=0.2, span=0.5, show.legend=FALSE, linewidth=0.4) +
  # geom_line(aes(colour=krm_ecotoop)) +
  guides(colour = guide_legend(nrow = 1)) +
  facet_wrap(~bht, ncol=2)

```


```{r, fig.asp=0.8, echo=FALSE, message=FALSE, warning=FALSE, comment=NA}

bisi_trend_mpa %>% 
  filter(indicator == "General quality") %>% 
  filter(sampling %notin% c("biomon", "biomon+wot","open","closed")) %>% 
           
  ggplot(aes(x=year, y=value, group=sampling)) +
  theme_publication() +
  geom_point(aes(colour=sampling, shape=sampling)) +
  geom_smooth(aes(colour=sampling), alpha=0.3, linewidth=0.4, span=0.4) +
  # geom_line(aes(colour=krm_ecotoop)) +
  guides(colour = guide_legend(nrow = 1)) +
  labs(y="BISI algemeen", x="") +
  facet_wrap(~mpa, ncol=2)

bisi_trend_mpa %>% 
  filter(indicator == "General quality") %>% 
  filter(sampling %notin% c("biomon", "biomon+wot","open","closed")) %>% 
           
  ggplot(aes(x=year, y=value)) +
  theme_publication() +
  geom_point() +
  geom_smooth(alpha=0.3, linewidth=0.4, span=0.4) +
  # geom_line(aes(colour=krm_ecotoop)) +
  guides(colour = guide_legend(nrow = 1)) +
  labs(y="BISI algemeen", x="") +
  facet_wrap(~mpa, ncol=2)

```

\newpage

*BISI en Sabellaria riffen op de Bruine Bank*

```{r, fig.asp=0.6, echo=FALSE, message=FALSE, warning=FALSE, comment=NA}

load(file=file.path(rdatadir,"sabellaria.RData"))

t <- 
  sabellaria %>% 
  sf::st_centroid()

ggplot() +
  theme_publication() +
  theme(legend.key.width=unit(1, "cm")) + 
  theme(legend.position = "right", legend.direction = "vertical") +
  theme(panel.grid.major = element_blank()) +
  geom_sf(data=nl_eez_all, fill=NA) +
  geom_sf(data=jff_comb, fill=NA, colour="red", linewidth=0.5) +
  geom_sf(data=euseamap_nl, aes(fill=krm_ecotoop), alpha=0.5) +
  geom_sf(data=t, aes(colour=value), lwd=0, size=0.1, show.legend = FALSE) +
  geom_sf(data=bisi_punt %>% filter(bisi_type=="bisi_algemeen", year == 2021, bemonstering == "schaaf_video"), 
          aes(size=value), colour="blue") +
  geom_sf(data = wsergrid, fill=NA, colour="gray", linewidth=0.1, alpha=0.5) +
  # geom_sf_text(data = wsergrid, aes(label=gridID), colour="gray20", size=3) +

  coord_sf(xlim=c(3.0,3.5), ylim=c(52.25,52.75)) +
  scale_size_continuous(range=c(0.5, 3)) +
  labs(size="BISI score", colour="Sabellaria score") +
  scale_colour_viridis(option="inferno", direction=-1)

```

*scenario maps*

```{r, fig.asp=0.8, echo=FALSE, message=FALSE, warning=FALSE, comment=NA}

# read scenario results

scenario_list <- list.files(path=file.path(scenariodir), pattern=".xlsx", full.names = TRUE) 
scenario_results <- scenario_results_habitats <- scenario_maps <- data.frame(stringsAsFactors = FALSE)
s <- scenario_list[1]
i <- 0

for (s in scenario_list) {
  
  nm <- basename(s)  
  
  if (grepl("leeg", nm)) next
  
  i <- i + 1
  print(nm)
  
  # read summary
  t1 <- 
    readxl::read_excel(s, col_names = TRUE, sheet = "Resultaat", range="B4:H11") %>% 
    lowcase() %>% 
    dplyr::select(-km2, -alletuigen) %>% 
    tidyr::pivot_longer(names_to = "vloot", values_to = "value", boomkor:zegens) %>% 
    mutate(variabele = "waarde van de vangst", scenario=gsub("Scenariotool v3","scenario", nm)) %>% 
    mutate(scenario2=stringr::word(scenario, 1)) 

  t2 <- 
    readxl::read_excel(s, col_names = TRUE, sheet = "Resultaat", range="J4:Q11") %>% 
    # lowcase() %>% 
    rename(gebied=Gebied) %>% 
    tidyr::pivot_longer(names_to = "krm_ecotoop", values_to = "value", "Diep grof sediment":"Overig") %>% 
    mutate(variabele = "oppervlak gesloten", scenario=gsub("Scenariotool v3","scenario", nm)) %>% 
    mutate(scenario2=stringr::word(scenario, 1)) 
  
  t3 <- 
    readxl::read_excel(s, col_names = TRUE, sheet = "Resultaat", range="T4:V11") %>% 
    lowcase() %>% 
    tidyr::pivot_longer(names_to = "variabele", values_to = "value", bisiscore:nbisikwadranten) %>% 
    mutate(scenario=gsub("Scenariotool v3","scenario", nm)) %>% 
    mutate(scenario2=stringr::word(scenario, 1)) 

  
  t4 <-
    bind_rows(
      # BB
      readxl::read_excel(s, col_names = FALSE, sheet = "BB", range="A3:I18") %>%
        rownames_to_column(var="rij") %>%
        pivot_longer(names_to = "kolom", values_to = "value", 2:ncol(.)) %>%
        mutate(gebied = "Bruine bank") %>%
        drop_na(value),

      # DB
      readxl::read_excel(s, col_names = FALSE, sheet = "DB", range="A2:Y43") %>%
        rownames_to_column(var="rij") %>%
        pivot_longer(names_to = "kolom", values_to = "value", 2:ncol(.)) %>%
        mutate(gebied = "Doggersbank") %>%
        drop_na(value),

      # FF
      readxl::read_excel(s, col_names = FALSE, sheet = "FF", range="A3:U28") %>%
        rownames_to_column(var="rij") %>%
        pivot_longer(names_to = "kolom", values_to = "value", 2:ncol(.)) %>%
        mutate(gebied = "Friese front") %>%
        drop_na(value),

      # KB
      readxl::read_excel(s, col_names = FALSE, sheet = "KB", range="A2:J16") %>%
        rownames_to_column(var="rij") %>%
        pivot_longer(names_to = "kolom", values_to = "value", 2:ncol(.)) %>%
        mutate(gebied = "Klaverbank") %>%
        drop_na(value),

      # NzK
      readxl::read_excel(s, col_names = FALSE, sheet = "NzK", range="A2:AF32") %>% 
        rownames_to_column(var="rij") %>% 
        pivot_longer(names_to = "kolom", values_to = "value", 2:ncol(.)) %>% 
        mutate(gebied = "Noordzee kustzone") %>% 
        drop_na(value),
      
      # VvdR
      readxl::read_excel(s, col_names = FALSE, sheet = "VvdR", range="A3:E8") %>% 
        rownames_to_column(var="rij") %>% 
        pivot_longer(names_to = "kolom", values_to = "value", 2:ncol(.)) %>% 
        mutate(gebied = "Vlakte van de Raan") %>% 
        drop_na(value),
      
      # VD
      readxl::read_excel(s, col_names = FALSE, sheet = "VD", range="A2:N18") %>% 
        rownames_to_column(var="rij") %>% 
        pivot_longer(names_to = "kolom", values_to = "value", 2:ncol(.)) %>% 
        mutate(gebied = "Voordelta") %>% 
        drop_na(value)
    ) %>% 
    mutate(scenario = nm) %>% 
    mutate(kolom = gsub("...","", kolom)) %>% 
    mutate(across(.cols=c(rij, kolom), as.integer)) %>% 
    filter(value != 0) %>% 
    mutate(scenario2=stringr::word(scenario, 1)) %>% 
    left_join(wsergrid, by=c("gebied", "rij","kolom"))
  
  r <-
    t2 %>% 
    group_by(krm_ecotoop) %>% 
    summarise(value = sum(value, na.rm=TRUE)) %>% 
    full_join(habitats_reeds_beschermd, by="krm_ecotoop") %>% 
    mutate(value = area_km2 + value) %>% 
    dplyr::select(-area_km2) %>% 
    full_join(habitats_in_eez, by="krm_ecotoop") %>% 
    mutate(prop_closed =  value / area_km2) %>% 
    rename(area_closed_km2=value, area_eez_km2=area_km2) %>% 
    mutate(scenario = nm) %>% 
    mutate(scenario2=stringr::word(scenario, 1))
  
  scenario_results <-
    bind_rows(scenario_results, t1, t2, t3)
  
  if (i == 1) scenario_results_habitats <- r else scenario_results_habitats <- bind_rows(scenario_results_habitats, r)
  
  if (i == 1) scenario_maps <- t4 else scenario_maps <- bind_rows(scenario_maps, t4)

}

```

```{r, fig.asp=0.5, echo=FALSE, message=FALSE, warning=FALSE, comment=NA}

t <- 
  scenario_maps %>% 
  group_by(scenario, scenario2) %>% 
  sf::st_as_sf() %>%
  summarize(geometry = sf::st_union(geometry))

t %>% 
  ggplot() +
  theme_publication() +
  theme(legend.key.width=unit(1, "cm")) + 
  geom_sf(data=nl_eez_all, fill=NA, inherit.aes = FALSE) +
  geom_sf(data=jff_comb, fill=NA, colour="red", linewidth=0.5, inherit.aes = FALSE) +
  geom_sf(fill="blue", colour="darkblue", alpha=0.5, linewidth=0.5) +

  coord_sf(xlim=c(bb[1],bb[3]), ylim=c(bb[2],bb[4])) +
  facet_wrap(~scenario, nrow=1)


```

\newpage

*scenario results*

```{r, fig.asp=0.6, echo=FALSE, message=FALSE, warning=FALSE, comment=NA}

# per scenario en gebied

opbrengst <- 
  scenario_results %>% 
  filter(variabele == "waarde van de vangst") %>% 
  filter(!is.na(value), value != 0) %>% 
  group_by(variabele, scenario, scenario2, gebied) %>%
  summarise(value = sum(value, na.rm=TRUE))

bisi <-
  scenario_results %>% 
  filter(variabele == "bisiscore") %>% 
  filter(!is.na(value), value != 0) %>% 
  group_by(scenario, scenario2) %>% 
  summarise(
    value = mean(value, na.rm=TRUE), 
    gebied = paste(gebied, collapse="_")
  )  %>% 
  mutate(variabele = "gem. BISI score")
  
oppervlak <-
  scenario_results %>% 
  filter(variabele == "oppervlak gesloten") %>% 
  filter(!is.na(value), value != 0) %>% 
  group_by(variabele, scenario, scenario2, gebied) %>%
  summarise(value = sum(value, na.rm=TRUE))
  
bind_rows(opbrengst, oppervlak, bisi) %>% 
  ggplot() +
  theme_publication() +
  theme(legend.position = "right", legend.direction = "vertical") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  geom_bar(aes(x=scenario, y=value, fill=gebied), stat="identity") +
  labs(x="", y="") +
  facet_wrap(~variabele, scale="free_y")



```

\newpage

*scenario results (2)*

```{r, fig.asp=0.8, echo=FALSE, message=FALSE, warning=FALSE, comment=NA}

# per scenario en vloot/habitat
opbrengst <- 
  scenario_results %>% 
  filter(variabele == "waarde van de vangst") %>% 
  filter(!is.na(value), value != 0) %>% 
  group_by(variabele, scenario, vloot) %>%
  summarise(value = sum(value, na.rm=TRUE))


oppervlak <-
  scenario_results %>% 
  filter(variabele == "oppervlak gesloten") %>% 
  filter(!is.na(value), value != 0) %>% 
  group_by(variabele, scenario, krm_ecotoop) %>%
  summarise(value = sum(value, na.rm=TRUE))
  
p1 <-
  opbrengst %>% 
  ggplot() +
  theme_publication() +
  theme(legend.position = "right", legend.direction = "vertical") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  geom_bar(aes(x=scenario, y=value, fill=vloot), stat="identity") +
  labs(x="", y="euro", title="waarde van de vangst") 

p2 <-
  oppervlak %>% 
  ggplot() +
  theme_publication() +
  theme(legend.position = "right", legend.direction = "vertical") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  geom_bar(aes(x=scenario, y=value, fill=krm_ecotoop), stat="identity") +
  labs(x="", y="km2", title="habitat gesloten") 

p1 + p2



```


\newpage

*scenario results (3)*

```{r, fig.asp=0.8}


p1 <-
  scenario_results_habitats %>% 
  mutate(area_open_km2 = area_eez_km2 - area_closed_km2) %>% 
  dplyr::select(-area_eez_km2, -prop_closed) %>% 
  tidyr::pivot_longer(names_to="variabele", values_to="value", c("area_open_km2", "area_closed_km2")) %>% 
  mutate(variabele = factor(variabele, levels=c( "area_open_km2","area_closed_km2"))) %>% 
  
  ggplot() +
  theme_publication() +
  theme(legend.position = "right", legend.direction = "vertical") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  geom_bar(aes(x=krm_ecotoop, y=value, fill=variabele), stat="identity") +
  labs(x="", y="km2") +
  facet_wrap(~scenario, nrow=1) +
  theme(axis.text.x=element_blank()) 

t <-
  scenario_results_habitats %>% 
  mutate(area_open_km2 = area_eez_km2 - area_closed_km2) %>% 
  dplyr::select(-area_eez_km2, -prop_closed) %>% 
  tidyr::pivot_longer(names_to="variabele", values_to="value", c("area_open_km2", "area_closed_km2")) %>% 
  mutate(variabele = factor(variabele, levels=c( "area_open_km2","area_closed_km2"))) %>% 
  group_by(scenario, scenario2, krm_ecotoop) %>% 
  mutate(
    prop_closed = value/sum(value),
    mytext = ifelse(variabele == "area_closed_km2", sprintf("%1.0f%%", prop_closed*100), NA)
  )

p2 <-
  t %>% 
  ggplot() +
  theme_publication() +
  theme(legend.position = "right", legend.direction = "vertical") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  geom_bar(aes(x=krm_ecotoop, y=value, fill=variabele), stat="identity", position="fill") +

  scale_y_continuous(labels = scales::percent_format()) +
  geom_hline(yintercept=0.1, colour="gray30") +
  geom_text(data=t , 
             aes(x=krm_ecotoop, y=prop_closed, label = mytext),
            colour = "black", size = 3.5, nudge_y =  -0.05) +
  labs(x="", y="percentage open/gesloten") +
  facet_wrap(~scenario, nrow=1)

p1 / p2 + 
  plot_layout(nrow = 2, guides="collect") &
  theme(legend.position='right') &
  theme(plot.margin = unit(c(0,0,0,0.5), "cm")) 

```
